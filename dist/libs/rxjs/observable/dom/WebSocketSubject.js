"use strict";var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},Subject_1=require("../../Subject"),Subscriber_1=require("../../Subscriber"),Observable_1=require("../../Observable"),Subscription_1=require("../../Subscription"),root_1=require("../../util/root"),ReplaySubject_1=require("../../ReplaySubject"),tryCatch_1=require("../../util/tryCatch"),errorObject_1=require("../../util/errorObject"),assign_1=require("../../util/assign"),WebSocketSubject=function(e){function t(t,r){if(t instanceof Observable_1.Observable)e.call(this,r,t);else{if(e.call(this),this.WebSocketCtor=root_1.root.WebSocket,this._output=new Subject_1.Subject,"string"==typeof t?this.url=t:assign_1.assign(this,t),!this.WebSocketCtor)throw new Error("no WebSocket constructor can be found");this.destination=new ReplaySubject_1.ReplaySubject}}return __extends(t,e),t.prototype.resultSelector=function(e){return JSON.parse(e.data)},t.create=function(e){return new t(e)},t.prototype.lift=function(e){var r=new t(this,this.destination);return r.operator=e,r},t.prototype._resetState=function(){this.socket=null,this.source||(this.destination=new ReplaySubject_1.ReplaySubject),this._output=new Subject_1.Subject},t.prototype.multiplex=function(e,t,r){var o=this;return new Observable_1.Observable(function(n){var c=tryCatch_1.tryCatch(e)();c===errorObject_1.errorObject?n.error(errorObject_1.errorObject.e):o.next(c);var s=o.subscribe(function(e){var t=tryCatch_1.tryCatch(r)(e);t===errorObject_1.errorObject?n.error(errorObject_1.errorObject.e):t&&n.next(e)},function(e){return n.error(e)},function(){return n.complete()});return function(){var e=tryCatch_1.tryCatch(t)();e===errorObject_1.errorObject?n.error(errorObject_1.errorObject.e):o.next(e),s.unsubscribe()}})},t.prototype._connectSocket=function(){var e=this,t=this.WebSocketCtor,r=this._output,o=null;try{o=this.protocol?new t(this.url,this.protocol):new t(this.url),this.socket=o}catch(e){return void r.error(e)}var n=new Subscription_1.Subscription(function(){e.socket=null,o&&1===o.readyState&&o.close()});o.onopen=function(t){var c=e.openObserver;c&&c.next(t);var s=e.destination;e.destination=Subscriber_1.Subscriber.create(function(e){return 1===o.readyState&&o.send(e)},function(t){var n=e.closingObserver;n&&n.next(void 0),t&&t.code?o.close(t.code,t.reason):r.error(new TypeError("WebSocketSubject.error must be called with an object with an error code, and an optional reason: { code: number, reason: string }")),e._resetState()},function(){var t=e.closingObserver;t&&t.next(void 0),o.close(),e._resetState()}),s&&s instanceof ReplaySubject_1.ReplaySubject&&n.add(s.subscribe(e.destination))},o.onerror=function(t){e._resetState(),r.error(t)},o.onclose=function(t){e._resetState();var o=e.closeObserver;o&&o.next(t),t.wasClean?r.complete():r.error(t)},o.onmessage=function(t){var o=tryCatch_1.tryCatch(e.resultSelector)(t);o===errorObject_1.errorObject?r.error(errorObject_1.errorObject.e):r.next(o)}},t.prototype._subscribe=function(e){var t=this,r=this.source;if(r)return r.subscribe(e);this.socket||this._connectSocket();var o=new Subscription_1.Subscription;return o.add(this._output.subscribe(e)),o.add(function(){var e=t.socket;0===t._output.observers.length&&(e&&1===e.readyState&&e.close(),t._resetState())}),o},t.prototype.unsubscribe=function(){var t=this,r=t.source,o=t.socket;o&&1===o.readyState&&(o.close(),this._resetState()),e.prototype.unsubscribe.call(this),r||(this.destination=new ReplaySubject_1.ReplaySubject)},t}(Subject_1.AnonymousSubject);exports.WebSocketSubject=WebSocketSubject;