"use strict";function bufferTime(e){var t=arguments.length,r=async_1.async;isScheduler_1.isScheduler(arguments[arguments.length-1])&&(r=arguments[arguments.length-1],t--);var i=null;t>=2&&(i=arguments[1]);var n=Number.POSITIVE_INFINITY;return t>=3&&(n=arguments[2]),this.lift(new BufferTimeOperator(e,i,n,r))}function dispatchBufferTimeSpanOnly(e){var t=e.subscriber,r=e.context;r&&t.closeContext(r),t.closed||(e.context=t.openContext(),e.context.closeAction=this.schedule(e,e.bufferTimeSpan))}function dispatchBufferCreation(e){var t=e.bufferCreationInterval,r=e.bufferTimeSpan,i=e.subscriber,n=e.scheduler,s=i.openContext(),o=this;i.closed||(i.add(s.closeAction=n.schedule(dispatchBufferClose,r,{subscriber:i,context:s})),o.schedule(e,t))}function dispatchBufferClose(e){var t=e.subscriber,r=e.context;t.closeContext(r)}var __extends=this&&this.__extends||function(e,t){function r(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)},async_1=require("../scheduler/async"),Subscriber_1=require("../Subscriber"),isScheduler_1=require("../util/isScheduler");exports.bufferTime=bufferTime;var BufferTimeOperator=function(){function e(e,t,r,i){this.bufferTimeSpan=e,this.bufferCreationInterval=t,this.maxBufferSize=r,this.scheduler=i}return e.prototype.call=function(e,t){return t.subscribe(new BufferTimeSubscriber(e,this.bufferTimeSpan,this.bufferCreationInterval,this.maxBufferSize,this.scheduler))},e}(),Context=function(){function e(){this.buffer=[]}return e}(),BufferTimeSubscriber=function(e){function t(t,r,i,n,s){e.call(this,t),this.bufferTimeSpan=r,this.bufferCreationInterval=i,this.maxBufferSize=n,this.scheduler=s,this.contexts=[];var o=this.openContext();if(this.timespanOnly=null==i||i<0,this.timespanOnly){var u={subscriber:this,context:o,bufferTimeSpan:r};this.add(o.closeAction=s.schedule(dispatchBufferTimeSpanOnly,r,u))}else{var c={subscriber:this,context:o},f={bufferTimeSpan:r,bufferCreationInterval:i,subscriber:this,scheduler:s};this.add(o.closeAction=s.schedule(dispatchBufferClose,r,c)),this.add(s.schedule(dispatchBufferCreation,i,f))}}return __extends(t,e),t.prototype._next=function(e){for(var t,r=this.contexts,i=r.length,n=0;n<i;n++){var s=r[n],o=s.buffer;o.push(e),o.length==this.maxBufferSize&&(t=s)}t&&this.onBufferFull(t)},t.prototype._error=function(t){this.contexts.length=0,e.prototype._error.call(this,t)},t.prototype._complete=function(){for(var t=this,r=t.contexts,i=t.destination;r.length>0;){var n=r.shift();i.next(n.buffer)}e.prototype._complete.call(this)},t.prototype._unsubscribe=function(){this.contexts=null},t.prototype.onBufferFull=function(e){this.closeContext(e);var t=e.closeAction;if(t.unsubscribe(),this.remove(t),!this.closed&&this.timespanOnly){e=this.openContext();var r=this.bufferTimeSpan,i={subscriber:this,context:e,bufferTimeSpan:r};this.add(e.closeAction=this.scheduler.schedule(dispatchBufferTimeSpanOnly,r,i))}},t.prototype.openContext=function(){var e=new Context;return this.contexts.push(e),e},t.prototype.closeContext=function(e){this.destination.next(e.buffer);var t=this.contexts,r=t?t.indexOf(e):-1;r>=0&&t.splice(t.indexOf(e),1)},t}(Subscriber_1.Subscriber);